<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OddsMax â€” Meilleures cotes du marchÃ©</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --accent: #c8f135;
    --accent2: #35f1c8;
    --text: #e8e8f0;
    --muted: #666680;
    --win1: #c8f135;
    --winX: #f1c835;
    --win2: #35c8f1;
    --danger: #f13535;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(200,241,53,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(200,241,53,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative;
    z-index: 10;
    padding: 32px 40px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.8rem;
    letter-spacing: 0.08em;
    color: var(--text);
    line-height: 1;
  }
  .logo span { color: var(--accent); }

  .tagline {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-top: 4px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .sport-tabs {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .tab {
    padding: 8px 16px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  .tab:hover { border-color: var(--accent); color: var(--accent); }
  .tab.active { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 600; }

  .refresh-btn {
    padding: 8px 20px;
    border-radius: 4px;
    border: 1px solid var(--accent);
    background: transparent;
    color: var(--accent);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  .refresh-btn:hover { background: var(--accent); color: var(--bg); }
  .refresh-btn.loading { opacity: 0.5; pointer-events: none; }
  .refresh-btn .spinner { display: none; }
  .refresh-btn.loading .spinner { display: inline-block; animation: spin 0.8s linear infinite; }
  .refresh-btn.loading .icon { display: none; }

  @keyframes spin { to { transform: rotate(360deg); } }

  main {
    position: relative;
    z-index: 1;
    padding: 32px 40px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
  }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    letter-spacing: 0.1em;
    color: var(--muted);
  }

  .count-badge {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 2px 10px;
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
  }

  /* API key notice */
  .api-notice {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: 6px;
    padding: 16px 20px;
    margin-bottom: 32px;
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    color: var(--muted);
    line-height: 1.6;
    display: none;
  }
  .api-notice.visible { display: block; }
  .api-notice strong { color: var(--accent); }

  /* Match cards grid */
  .matches-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .match-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.2s;
    animation: fadeIn 0.4s ease both;
  }
  .match-card:hover { border-color: #3a3a50; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .match-header {
    padding: 16px 20px;
    display: grid;
    grid-template-columns: 1fr auto auto;
    align-items: center;
    gap: 16px;
    border-bottom: 1px solid var(--border);
  }

  .match-teams {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .team {
    font-weight: 500;
    font-size: 0.95rem;
  }

  .vs {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    text-transform: uppercase;
  }

  .match-meta {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    text-align: right;
  }

  .league-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--accent2);
    background: rgba(53,241,200,0.08);
    border: 1px solid rgba(53,241,200,0.2);
    border-radius: 3px;
    padding: 2px 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
  }

  /* Best odds highlight row */
  .best-odds-row {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--surface2);
  }
  .best-odds-row .outcome-col {
    flex: 1;
  }

  .outcome-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .outcome-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--muted);
  }

  .best-odd {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.2rem;
    letter-spacing: 0.05em;
    line-height: 1;
  }
  .outcome-col:nth-child(1) .best-odd { color: var(--win1); }
  .outcome-col:nth-child(2) .best-odd { color: var(--winX); }
  .outcome-col:nth-child(3) .best-odd { color: var(--win2); }

  .best-book {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    text-transform: uppercase;
  }

  /* Bookmakers detail row */
  .books-detail {
    padding: 0 20px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }
  .books-detail.open {
    max-height: 600px;
    padding: 16px 20px;
  }

  .books-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
  }

  .books-table th {
    text-align: left;
    color: var(--muted);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0 8px 10px 8px;
    border-bottom: 1px solid var(--border);
  }
  .books-table th:not(:first-child) { text-align: center; }

  .books-table td {
    padding: 8px;
    border-bottom: 1px solid rgba(42,42,58,0.5);
    color: var(--text);
  }
  .books-table td:not(:first-child) { text-align: center; }
  .books-table tr:last-child td { border-bottom: none; }

  .odd-cell { font-size: 0.85rem; }
  .odd-cell.is-best { color: var(--accent); font-weight: 600; }

  .book-name {
    color: var(--muted);
    font-size: 0.72rem;
  }

  .roi-badge {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border: 1px solid;
    border-radius: 6px;
    min-width: 90px;
    flex-shrink: 0;
    gap: 2px;
    background: rgba(0,0,0,0.2);
  }
  .roi-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
  }
  .roi-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    letter-spacing: 0.05em;
    line-height: 1;
  }

  .toggle-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    padding: 10px;
    background: transparent;
    border: none;
    border-top: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: color 0.2s, background 0.2s;
  }
  .toggle-btn:hover { color: var(--text); background: var(--surface2); }

  /* Polymarket section */
  .poly-section {
    margin-top: 48px;
  }

  .poly-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: #9e7bff;
    background: rgba(158,123,255,0.1);
    border: 1px solid rgba(158,123,255,0.25);
    border-radius: 3px;
    padding: 2px 8px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .poly-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    align-items: center;
    gap: 16px;
    animation: fadeIn 0.4s ease both;
    transition: border-color 0.2s;
  }
  .poly-card:hover { border-color: rgba(158,123,255,0.3); }

  .poly-title {
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 4px;
  }

  .poly-subtitle {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
  }

  .poly-odd {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.8rem;
    text-align: center;
    line-height: 1;
  }
  .poly-odd.yes { color: var(--win1); }
  .poly-odd.no { color: var(--danger); }

  .poly-odd-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    text-transform: uppercase;
    color: var(--muted);
    text-align: center;
    margin-top: 2px;
  }

  /* States */
  .state-empty {
    text-align: center;
    padding: 80px 20px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
  }
  .state-empty .big { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; display: block; color: var(--surface2); margin-bottom: 12px; }

  .error-bar {
    background: rgba(241,53,53,0.1);
    border: 1px solid rgba(241,53,53,0.3);
    border-radius: 6px;
    padding: 12px 16px;
    color: #f17070;
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    margin-bottom: 20px;
    display: none;
  }
  .error-bar.visible { display: block; }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 24px;
    padding: 16px 40px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-wrap: wrap;
  }
  .stat {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .stat-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem;
    color: var(--accent);
    line-height: 1;
  }
  .stat-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  @media (max-width: 700px) {
    header { padding: 20px; }
    main { padding: 20px; }
    .match-header { grid-template-columns: 1fr; }
    .poly-card { grid-template-columns: 1fr 1fr; }
    .stats-bar { padding: 12px 20px; gap: 16px; }
  }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">Odds<span>Max</span></div>
    <div class="tagline">Meilleures cotes Â· Tous bookmakers</div>
  </div>
  <div class="header-right">
    <div class="sport-tabs" id="sportTabs">
      <button class="tab active" data-sport="soccer_france_ligue_one">Ligue 1</button>
      <button class="tab" data-sport="soccer_epl">Premier League</button>
      <button class="tab" data-sport="soccer_spain_la_liga">La Liga</button>
      <button class="tab" data-sport="soccer_italy_serie_a">Serie A</button>
      <button class="tab" data-sport="soccer_germany_bundesliga">Bundesliga</button>
      <button class="tab" data-sport="soccer_uefa_champs_league">Champions League</button>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="loadAll()">
      <span class="icon">â†»</span>
      <span class="spinner">â—Œ</span>
      RafraÃ®chir
    </button>
  </div>
</header>

<div class="stats-bar" id="statsBar">
  <div class="stat">
    <span class="stat-val" id="statMatches">â€”</span>
    <span class="stat-label">Matchs</span>
  </div>
  <div class="stat">
    <span class="stat-val" id="statBooks">â€”</span>
    <span class="stat-label">Bookmakers</span>
  </div>
  <div class="stat">
    <span class="stat-val" id="statLastUpdate">â€”</span>
    <span class="stat-label">Mise Ã  jour</span>
  </div>
  <div class="stat">
    <span class="stat-val" id="statQuota">â€”</span>
    <span class="stat-label">RequÃªtes restantes</span>
  </div>
  <div id="backendBadge" style="display:none;align-items:center;margin-left:auto;font-family:'DM Mono',monospace;font-size:0.72rem;color:#c8f135;background:rgba(200,241,53,0.08);border:1px solid rgba(200,241,53,0.2);border-radius:4px;padding:4px 12px;"></div>
</div>

<main>
  <div class="error-bar" id="errorBar"></div>

  <!-- Bookmakers section -->
  <div class="section-header">
    <div class="section-title">Bookmakers</div>
    <div class="count-badge" id="matchCount">0 matchs</div>
  </div>

  <div class="matches-grid" id="matchesGrid">
    <div class="state-empty">
      <span class="big">ODDSMAX</span>
      Clique sur RafraÃ®chir pour charger les cotes
    </div>
  </div>

  <!-- Polymarket section -->
  <div class="poly-section">
    <div class="section-header">
      <div class="section-title">Polymarket</div>
      <div class="poly-badge">MarchÃ©s prÃ©dictifs</div>
      <div class="count-badge" id="polyCount">0 marchÃ©s</div>
    </div>
    <div class="matches-grid" id="polyGrid">
      <div class="state-empty">
        <span class="big">POLY</span>
        Chargement des marchÃ©s Polymarket...
      </div>
    </div>
  </div>
</main>

<script>
const API_KEY = 'b6e969d7c1e1593bc1a011708f36e9c2';
const BASE_URL = 'https://api.the-odds-api.com/v4';

// Bookmaker name mapping (key â†’ display name)
const BOOK_NAMES = {
  winamax: 'Winamax',
  betclic: 'Betclic',
  parionssport: 'ParionsSport',
  betclic: 'Betclic',
  winamax: 'Winamax',
  unibet: 'Unibet',
  unibet_fr: 'Unibet FR',
  betway: 'Betway',
  bwin: 'Bwin',
  pmu: 'PMU',
  parionssport: 'ParionsSport',
  zebet: 'ZEbet',
  betfair: 'Betfair',
  bet365: 'Bet365',
  williamhill: 'William Hill',
  pinnacle: 'Pinnacle',
  draftkings: 'DraftKings',
  fanduel: 'FanDuel',
  bovada: 'Bovada',
};

function bookName(key) {
  return BOOK_NAMES[key] || key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

let currentSport = 'soccer_france_ligue_one';

// Global store for polymarket data keyed by normalized team names
let polymarketData = {}; // { 'team1_team2': { home, draw, away, slug } }

// Normalize team name for matching
function normTeam(name) {
  return (name || '').toLowerCase()
    .replace(/stade brestois 29/i, 'brest')
    .replace(/olympique de marseille/i, 'marseille')
    .replace(/paris saint.germain/i, 'psg')
    .replace(/olympique lyonnais/i, 'lyon')
    .replace(/as monaco/i, 'monaco')
    .replace(/ogc nice/i, 'nice')
    .replace(/rc lens/i, 'lens')
    .replace(/losc lille/i, 'lille')
    .replace(/stade rennais/i, 'rennes')
    .replace(/rc strasbourg/i, 'strasbourg')
    .replace(/fc nantes/i, 'nantes')
    .replace(/toulouse fc/i, 'toulouse')
    .replace(/montpellier/i, 'montpellier')
    .replace(/le havre/i, 'le havre')
    .replace(/stade de reims/i, 'reims')
    .replace(/fc lorient/i, 'lorient')
    .replace(/angers sco/i, 'angers')
    .replace(/mans fc/i, 'le mans')
    .replace(/aj auxerre/i, 'auxerre')
    .replace(/saint.etienne/i, 'saint-etienne')
    .replace(/inter milan/i, 'inter')
    .replace(/ac milan/i, 'milan')
    .replace(/juventus/i, 'juventus')
    .replace(/manchester city/i, 'man city')
    .replace(/manchester united/i, 'man united')
    .replace(/arsenal/i, 'arsenal')
    .replace(/chelsea/i, 'chelsea')
    .replace(/liverpool/i, 'liverpool')
    .replace(/real madrid/i, 'real madrid')
    .replace(/atletico/i, 'atletico')
    .replace(/barcelona/i, 'barcelona')
    .replace(/fc /g, '')
    .replace(/\bsc\b/g, '')
    .replace(/\bfc\b/g, '')
    .trim();
}

function teamsMatch(a, b) {
  const na = normTeam(a), nb = normTeam(b);
  return na === nb || na.includes(nb) || nb.includes(na);
}

// Tab switching
document.getElementById('sportTabs').addEventListener('click', e => {
  const tab = e.target.closest('.tab');
  if (!tab) return;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  currentSport = tab.dataset.sport;
  loadAll();
});

async function loadAll() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading');
  hideError();
  polymarketData = {};

  await Promise.all([fetchBookmakers(), fetchPolymarket(), fetchLocalBackend()]);
  btn.classList.remove('loading');
}

// Local backend odds (Betclic, Winamax, ParionsSport)
let localBackendData = {}; // { normKey: {winamax, betclic, parionssport} }

async function fetchLocalBackend() {
  try {
    const res = await fetch(`http://localhost:5000/odds/${currentSport}`, { signal: AbortSignal.timeout(3000) });
    if (!res.ok) return;
    const data = await res.json();

    localBackendData = {};
    const bookies = ['winamax', 'betclic', 'parionssport'];
    bookies.forEach(bk => {
      (data[bk] || []).forEach(m => {
        const key = normTeam(m.home) + '|' + normTeam(m.away);
        if (!localBackendData[key]) localBackendData[key] = {};
        localBackendData[key][bk] = { home: m.home_odd, draw: m.draw_odd, away: m.away_odd };
      });
    });

    // Show backend status badge
    const total = Object.keys(localBackendData).length;
    document.getElementById('backendBadge').style.display = total > 0 ? 'flex' : 'none';
    document.getElementById('backendBadge').textContent = `ðŸŸ¢ Backend actif Â· ${total} matchs`;

    // Re-render with new data
    if (window._lastMatchData) renderMatches(window._lastMatchData);
  } catch(e) {
    document.getElementById('backendBadge').style.display = 'none';
  }
}

async function fetchBookmakers() {
  try {
    const url = `${BASE_URL}/sports/${currentSport}/odds/?apiKey=${API_KEY}&regions=eu&markets=h2h&oddsFormat=decimal&bookmakers=betclic,winamax,unibet_fr,betway,bwin,zebet,parionssport,pmu,bet365,williamhill,pinnacle`;
    const res = await fetch(url);
    const quota = res.headers.get('x-requests-remaining');
    if (quota) document.getElementById('statQuota').textContent = quota;
    if (!res.ok) { const e = await res.json().catch(()=>({})); throw new Error(e.message || `HTTP ${res.status}`); }
    const data = await res.json();
    renderMatches(data);
  } catch(err) {
    showError(err.message);
  }
}

async function fetchPolymarket() {
  const grid = document.getElementById('polyGrid');
  try {
    const LEAGUE_SLUGS = ['ligue-1','premier-league','la-liga','serie-a','bundesliga','champions-league'];
    const proxyBase = 'https://corsproxy.io/?';

    const results = await Promise.all(LEAGUE_SLUGS.map(async league => {
      try {
        const url = `https://gamma-api.polymarket.com/events?active=true&closed=false&tag_slug=${league}&limit=30&order=startDate&ascending=true`;
        const r = await fetch(proxyBase + encodeURIComponent(url));
        if (!r.ok) return [];
        const d = await r.json();
        return Array.isArray(d) ? d : [];
      } catch { return []; }
    }));

    const seen = new Set();
    const allEvents = results.flat().filter(e => {
      if (seen.has(e.id)) return false;
      seen.add(e.id);
      return true;
    });

    // Parse each event and store in polymarketData
    allEvents.forEach(event => {
      const subMarkets = event.markets || [];
      if (subMarkets.length < 2) return;

      // Extract the 3 outcomes (home/draw/away) from sub-markets
      // groupItemTitle contains team name or "Draw"
      const outcomes = subMarkets.map(sm => ({
        name: (sm.groupItemTitle || sm.question || '').trim(),
        price: parseFloat(sm.lastTradePrice || sm.price || 0) || 0,
        slug: event.slug
      }));

      // Try to identify home/draw/away
      let home = null, draw = null, away = null;
      outcomes.forEach(o => {
        const n = o.name.toLowerCase();
        if (n.includes('draw') || n.includes('nul')) draw = o;
        else if (!home) home = o;
        else if (!away) away = o;
      });

      if (!home || !away) return;

      // Convert probability to decimal odds
      const toDecimal = p => p > 0 ? parseFloat((1/p).toFixed(2)) : null;

      const entry = {
        home: toDecimal(home.price),
        draw: draw ? toDecimal(draw.price) : null,
        away: toDecimal(away.price),
        homeTeam: home.name,
        awayTeam: away.name,
        slug: event.slug,
        title: event.title
      };

      // Store by both team names for lookup
      const key = normTeam(home.name) + '|' + normTeam(away.name);
      polymarketData[key] = entry;
    });

    document.getElementById('polyCount').textContent = `${Object.keys(polymarketData).length} matchs`;
    // Re-render matches with poly data injected
    // (renderMatches reads polymarketData globally)
    const grid2 = document.getElementById('matchesGrid');
    if (grid2.querySelector('.match-card')) {
      // Already rendered, just refresh
      const lastData = window._lastMatchData;
      if (lastData) renderMatches(lastData);
    }

    // Also render the standalone poly section
    renderPolySection(allEvents);

  } catch(err) {
    grid.innerHTML = `<div class="state-empty"><span class="big">!</span>Polymarket : ${err.message}</div>`;
  }
}

function renderPolySection(allEvents) {
  const grid = document.getElementById('polyGrid');
  const FOOTBALL_PATTERNS = [/ligue.?1/i,/premier.?league/i,/la.?liga/i,/serie.?a/i,/bundesliga/i,/champions.?league/i];
  const football = allEvents.filter(e => {
    const q = e.title || e.slug || '';
    return FOOTBALL_PATTERNS.some(p => p.test(q)) || (e.markets||[]).length >= 3;
  }).slice(0, 30);

  if (!football.length) {
    grid.innerHTML = `<div class="state-empty"><span class="big">â€”</span>Aucun match Polymarket trouvÃ© pour ce championnat.</div>`;
    return;
  }

  grid.innerHTML = football.map((event, idx) => {
    const subMarkets = event.markets || [];
    const vol = parseFloat(event.volume || 0);
    const volume = vol > 0 ? `Vol. $${Math.round(vol).toLocaleString('fr-FR')}` : '';
    const startDate = event.startDate ? new Date(event.startDate).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
    const polyLink = `https://polymarket.com/event/${event.slug || ''}`;

    const outcomes = subMarkets.map(sm => ({
      name: (sm.groupItemTitle || sm.question || '?').trim(),
      price: parseFloat(sm.lastTradePrice || sm.price || 0) || 0
    }));

    const toOdd = p => p > 0 ? (1/p).toFixed(2) : 'â€”';
    const toProb = p => p > 0 ? `${(p*100).toFixed(0)}%` : 'â€”';

    const cols = outcomes.slice(0,3).map(o => `
      <div>
        <div class="poly-odd yes" style="font-size:1.4rem">${toProb(o.price)}</div>
        <div class="poly-odd-label">${o.name}<br><span style="color:var(--accent)">${toOdd(o.price)}x</span></div>
      </div>`).join('');

    return `
    <div class="poly-card" style="animation-delay:${idx*0.04}s;cursor:pointer" onclick="window.open('${polyLink}','_blank')">
      <div>
        <div class="poly-title">${event.title || 'Match'}</div>
        <div class="poly-subtitle">${[volume, startDate].filter(Boolean).join(' Â· ')}</div>
      </div>
      ${cols}
    </div>`;
  }).join('');
}

function renderMatches(data) {
  window._lastMatchData = data;
  const grid = document.getElementById('matchesGrid');

  if (!data || data.length === 0) {
    grid.innerHTML = `<div class="state-empty"><span class="big">0</span>Aucun match disponible pour ce championnat actuellement.</div>`;
    document.getElementById('matchCount').textContent = '0 matchs';
    document.getElementById('statMatches').textContent = '0';
    return;
  }

  const allBooks = new Set();
  data.forEach(m => m.bookmakers?.forEach(b => allBooks.add(b.key)));

  document.getElementById('statMatches').textContent = data.length;
  document.getElementById('statBooks').textContent = allBooks.size;
  document.getElementById('statLastUpdate').textContent = new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('matchCount').textContent = `${data.length} matchs`;

  grid.innerHTML = data.map((match, idx) => {
    const date = new Date(match.commence_time);
    const dateStr = date.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'}) + ' ' + date.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});

    // Bookmaker odds
    const bookOdds = {};
    match.bookmakers?.forEach(bk => {
      const h2h = bk.markets?.find(m => m.key === 'h2h');
      if (!h2h) return;
      const outcomes = {};
      h2h.outcomes.forEach(o => {
        if (o.name === match.home_team) outcomes.home = o.price;
        else if (o.name === match.away_team) outcomes.away = o.price;
        else outcomes.draw = o.price;
      });
      bookOdds[bk.key] = outcomes;
    });

    // Inject local backend odds (Betclic, Winamax, ParionsSport)
    const normHome = normTeam(match.home_team);
    const normAway = normTeam(match.away_team);
    for (const [key, bkData] of Object.entries(localBackendData)) {
      const [kHome, kAway] = key.split('|');
      if ((teamsMatch(normHome, kHome) && teamsMatch(normAway, kAway)) ||
          (teamsMatch(normHome, kAway) && teamsMatch(normAway, kHome))) {
        Object.entries(bkData).forEach(([bkName, odds]) => {
          if (odds.home || odds.away) bookOdds[bkName] = odds;
        });
        break;
      }
    }

    // Inject Polymarket odds if we have a match
    let polyEntry = null;
    for (const [key, entry] of Object.entries(polymarketData)) {
      const [kHome, kAway] = key.split('|');
      if ((teamsMatch(normHome, kHome) && teamsMatch(normAway, kAway)) ||
          (teamsMatch(normHome, kAway) && teamsMatch(normAway, kHome))) {
        polyEntry = entry;
        break;
      }
    }
    if (polyEntry) {
      bookOdds['polymarket'] = { home: polyEntry.home, draw: polyEntry.draw, away: polyEntry.away };
    }

    // Best odds
    const best = {home:{val:0,book:''},draw:{val:0,book:''},away:{val:0,book:''}};
    Object.entries(bookOdds).forEach(([key, odds]) => {
      if ((odds.home||0) > best.home.val) best.home = {val:odds.home, book:key};
      if ((odds.draw||0) > best.draw.val) best.draw = {val:odds.draw, book:key};
      if ((odds.away||0) > best.away.val) best.away = {val:odds.away, book:key};
    });

    // ROI / margin calculation using best odds
    const bestHome = best.home.val || 0;
    const bestDraw = best.draw.val || 0;
    const bestAway = best.away.val || 0;
    let roi = null, margin = null;
    if (bestHome > 0 && bestAway > 0) {
      const impliedSum = (1/bestHome) + (bestDraw > 0 ? 1/bestDraw : 0) + (1/bestAway);
      margin = ((impliedSum - 1) * 100);
      roi = ((1 / impliedSum) * 100);
    }
    const roiColor = roi === null ? 'var(--muted)' : roi >= 100 ? '#c8f135' : roi >= 97 ? '#f1c835' : '#f17070';
    const roiBadge = roi !== null ? `
      <div class="roi-badge" style="color:${roiColor};border-color:${roiColor}">
        <span class="roi-label">Retour</span>
        <span class="roi-val">${roi.toFixed(2)}%</span>
      </div>` : '';

    const bookKeys = Object.keys(bookOdds);
    const tableRows = bookKeys.map(key => {
      const o = bookOdds[key];
      const isPoly = key === 'polymarket';
      const polyStyle = isPoly ? 'style="color:#9e7bff"' : '';
      const polyLink = isPoly && polyEntry ? `onclick="window.open('https://polymarket.com/event/${polyEntry.slug}','_blank')" style="cursor:pointer;color:#9e7bff"` : '';
      return `<tr ${polyLink}>
        <td class="book-name" ${polyStyle}>${isPoly ? 'ðŸŸ£ Polymarket' : bookName(key)}</td>
        <td class="odd-cell ${key === best.home.book ? 'is-best' : ''}">${o.home?.toFixed(2) || 'â€”'}</td>
        <td class="odd-cell ${key === best.draw.book ? 'is-best' : ''}">${o.draw?.toFixed(2) || 'â€”'}</td>
        <td class="odd-cell ${key === best.away.book ? 'is-best' : ''}">${o.away?.toFixed(2) || 'â€”'}</td>
      </tr>`;
    }).join('');

    const animDelay = idx * 0.05;
    const hasPoly = !!polyEntry;

    return `
    <div class="match-card" style="animation-delay:${animDelay}s">
      <div class="match-header">
        <div class="match-teams">
          <span class="team">${match.home_team}</span>
          <span class="vs">vs</span>
          <span class="team">${match.away_team}</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          ${hasPoly ? `<span style="font-family:'DM Mono',monospace;font-size:0.65rem;color:#9e7bff;background:rgba(158,123,255,0.1);border:1px solid rgba(158,123,255,0.25);border-radius:3px;padding:2px 8px">ðŸŸ£ POLY</span>` : ''}
          <span class="league-tag">${match.sport_title || ''}</span>
        </div>
        <div class="match-meta">${dateStr}</div>
      </div>

      <div class="best-odds-row">
        ${roiBadge}
        <div class="outcome-col">
          <div class="outcome-label">1 â€” Domicile</div>
          <div class="best-odd">${best.home.val ? best.home.val.toFixed(2) : 'â€”'}</div>
          <div class="best-book">${best.home.book === 'polymarket' ? 'ðŸŸ£ Polymarket' : (best.home.book ? bookName(best.home.book) : '')}</div>
        </div>
        <div class="outcome-col">
          <div class="outcome-label">X â€” Nul</div>
          <div class="best-odd">${best.draw.val ? best.draw.val.toFixed(2) : 'â€”'}</div>
          <div class="best-book">${best.draw.book === 'polymarket' ? 'ðŸŸ£ Polymarket' : (best.draw.book ? bookName(best.draw.book) : '')}</div>
        </div>
        <div class="outcome-col">
          <div class="outcome-label">2 â€” ExtÃ©rieur</div>
          <div class="best-odd">${best.away.val ? best.away.val.toFixed(2) : 'â€”'}</div>
          <div class="best-book">${best.away.book === 'polymarket' ? 'ðŸŸ£ Polymarket' : (best.away.book ? bookName(best.away.book) : '')}</div>
        </div>
      </div>

      ${bookKeys.length > 0 ? `
      <div class="books-detail" id="detail-${idx}">
        <table class="books-table">
          <thead><tr><th>Bookmaker</th><th>1</th><th>X</th><th>2</th></tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>
      <button class="toggle-btn" onclick="toggleDetail('${idx}', this)">
        â–¾ Voir tous les bookmakers (${bookKeys.length}${hasPoly ? ' + Polymarket' : ''})
      </button>` : ''}
    </div>`;
  }).join('');
}

function toggleDetail(idx, btn) {
  const el = document.getElementById(`detail-${idx}`);
  el.classList.toggle('open');
  btn.textContent = el.classList.contains('open') ? 'â–´ Masquer les bookmakers' : `â–¾ Voir tous les bookmakers`;
}

function showError(msg) {
  const bar = document.getElementById('errorBar');
  bar.textContent = `Erreur : ${msg}`;
  bar.classList.add('visible');
}

function hideError() {
  document.getElementById('errorBar').classList.remove('visible');
}

window.addEventListener('load', loadAll);
</script>

</body>
</html>
